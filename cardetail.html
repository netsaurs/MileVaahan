<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Car Details ‚Äì MileVaahan</title>
  <meta name="description" id="page-desc" content="" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" id="page-canonical" href="https://www.milevaahan.com/pages/car-detail.html" />
  <meta property="og:type" content="product" />
  <meta property="og:title" id="og-title" content="" />
  <meta property="og:description" id="og-desc" content="" />
  <meta property="og:image" id="og-image" content="" />
  <script type="application/ld+json" id="car-schema">{}</script>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    *{font-family:'DM Sans',sans-serif;} h1,h2,h3,.font-display{font-family:'Syne',sans-serif;}
    body{background:#f8fafc;color:#1e293b;}
    .nav-glass{background:rgba(10,22,40,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(180,140,11,0.2);}
    .thumb{width:80px;height:60px;border-radius:10px;object-fit:cover;cursor:pointer;border:2px solid transparent;transition:all 0.2s;}
    .thumb.active{border-color:#0d9488;}
    .spec-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9;}
    .spec-row:last-child{border-bottom:none;}
    #global-loader{position:fixed;inset:0;z-index:9999;background:rgba(10,22,40,0.95);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
    .loader-ring{width:40px;height:40px;border:3px solid rgba(180,140,11,0.2);border-top-color:#B8860B;border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .contact-card{background:white;border:1px solid #e2e8f0;border-radius:16px;padding:20px;position:sticky;top:80px;}
    .whatsapp-btn{background:#25D366;color:white;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:12px;font-weight:700;font-size:14px;text-decoration:none;transition:all 0.2s;}
    .whatsapp-btn:hover{background:#128C7E;transform:translateY(-1px);}
    .call-btn{background:linear-gradient(135deg,#0d9488,#0284c7);color:white;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;transition:all 0.2s;border:none;width:100%;}
    .call-btn:hover{opacity:0.9;transform:translateY(-1px);}
  </style>
</head>
<body>

<nav class="nav-glass fixed top-0 left-0 right-0 z-50">
  <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
    <a href="../index.html" class="flex items-center gap-3">
      <img src="../MaileVaahan.png" alt="MileVaahan" class="h-20 w-20 object-contain"/>
      <span class="text-white font-display font-bold text-lg">mile<span style="color:#B8860B">vaahan</span></span>
    </a>
    <a href="listings.html" class="text-gray-300 hover:text-white text-sm">‚Üê Back to Listings</a>
  </div>
</nav>

<div class="pt-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6" aria-label="Breadcrumb">
    <a href="../index.html" class="hover:text-teal-600">Home</a> /
    <a href="listings.html" class="hover:text-teal-600">Listings</a> /
    <span id="breadcrumb-car" class="text-gray-900 font-medium">Car Details</span>
  </nav>

  <div id="car-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Loading -->
    <div class="lg:col-span-3 flex justify-center py-20">
      <div class="loader-ring" style="border-top-color:#0d9488;"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="../js/firebase-config.js"></script>
<script>
let carData = null;
let currentImgIdx = 0;

window.addEventListener('load', async () => {
  setTimeout(() => showLoader(false), 600);
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if (id) await loadCar(id);
  else showError();
});

async function loadCar(id) {
  try {
    const doc = await db.collection(COLLECTIONS.LISTINGS).doc(id).get();
    carData = doc.exists ? { id: doc.id, ...doc.data() } : null;
    if (!carData) carData = getSampleCar(id);
  } catch(e) { carData = getSampleCar(id); }
  renderCar();
  updateSEO();
  // Increment view count
  try { db.collection(COLLECTIONS.LISTINGS).doc(id).update({ views: firebase.firestore.FieldValue.increment(1) }); } catch(e) {}
}

function getSampleCar(id) {
  return {
    id, make:'Hyundai', model:'Creta', year:2023, variant:'SX(O) Turbo', price:1450000,
    condition:'used', fuel:'Petrol', transmission:'DCT', bodyType:'SUV', color:'White',
    mileage:12000, engine:'1497cc Turbo', ownerType:'1st Owner',
    city:'Mumbai', state:'Maharashtra',
    description:'Well-maintained 2023 Hyundai Creta SX(O) Turbo. All service records available. No accidents. Single owner. All features working perfectly including sunroof, ventilated seats, 360 camera.',
    phone:'+91 98765 43210', whatsApp:'+91 98765 43210',
    negotiable:true, exchange:false, featured:true,
    dealerName:'AutoMax Mumbai', dealerVerified:true,
    images:[], createdAt:{ toDate:()=>new Date() },
    seo:{ title:'2023 Hyundai Creta SX(O) for Sale in Mumbai | MileVaahan', description:'Buy 2023 Hyundai Creta SX(O) Turbo in Mumbai. 12,000 km driven. Petrol, DCT. Price: ‚Çπ14.50 Lakh.' }
  };
}

function renderCar() {
  const c = carData;
  const conditionBadge = { new:'‚ú® New', used:'Used', cpo:'üèÜ Certified Pre-Owned' };
  const images = c.images?.length ? c.images : [''];

  document.getElementById('breadcrumb-car').textContent = `${c.year} ${c.make} ${c.model}`;

  const html = `
    <!-- LEFT: Images + Details -->
    <div class="lg:col-span-2 space-y-5">
      <!-- Image Gallery -->
      <div class="bg-white rounded-2xl overflow-hidden border border-gray-100">
        <div class="relative" style="height:380px;background:linear-gradient(135deg,#e2e8f0,#f0fdfb);">
          ${images[0] ? `<img id="main-img" src="${images[0]}" alt="${c.year} ${c.make} ${c.model}" class="w-full h-full object-cover" />` : `<div class="w-full h-full flex items-center justify-center text-8xl">üöó</div>`}
          <span class="absolute top-4 left-4 text-white text-xs font-bold px-3 py-1.5 rounded-xl" style="background:${c.condition==='new'?'linear-gradient(135deg,#0d9488,#0284c7)':c.condition==='cpo'?'linear-gradient(135deg,#B8860B,#d97706)':'linear-gradient(135deg,#64748b,#475569)'}">
            ${conditionBadge[c.condition]||'Used'}
          </span>
          ${c.featured?'<span class="absolute top-4 right-4 text-white text-xs font-bold px-2 py-1 rounded-lg" style="background:linear-gradient(135deg,#B8860B,#D4A017)">‚≠ê Featured</span>':''}
          ${images.length > 1 ? `
            <button onclick="prevImg()" class="absolute left-3 top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-white/90 flex items-center justify-center shadow-md hover:bg-white transition-colors">‚Äπ</button>
            <button onclick="nextImg()" class="absolute right-3 top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-white/90 flex items-center justify-center shadow-md hover:bg-white transition-colors">‚Ä∫</button>` : ''}
        </div>
        ${images.length > 1 ? `<div class="flex gap-2 p-3 overflow-x-auto">${images.map((img,i)=>`<img src="${img}" alt="Photo ${i+1}" class="thumb ${i===0?'active':''}" onclick="setImg(${i})" />`).join('')}</div>` : ''}
      </div>

      <!-- Title & Price -->
      <div class="bg-white rounded-2xl p-6 border border-gray-100">
        <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-3 mb-4">
          <div>
            <h1 class="font-display text-2xl font-bold text-gray-900" itemprop="name">${c.year} ${c.make} ${c.model} ${c.variant||''}</h1>
            <p class="text-gray-500 text-sm mt-1 flex items-center gap-2">üìç ${c.city}, ${c.state} <span class="text-gray-300">‚Ä¢</span> ${timeAgo(c.createdAt)}</p>
          </div>
          <div class="text-right">
            <div class="font-display text-3xl font-bold" style="color:#0f766e">${formatPrice(c.price)}</div>
            ${c.negotiable?'<span class="text-xs text-green-600 font-medium bg-green-50 px-2 py-0.5 rounded-full">Negotiable</span>':''}
          </div>
        </div>
        <!-- Quick Specs -->
        <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
          <div class="text-center p-3 rounded-xl bg-gray-50">
            <div class="text-lg mb-1">‚õΩ</div><div class="text-xs font-bold text-gray-700">${c.fuel}</div><div class="text-xs text-gray-400">Fuel</div>
          </div>
          <div class="text-center p-3 rounded-xl bg-gray-50">
            <div class="text-lg mb-1">‚öôÔ∏è</div><div class="text-xs font-bold text-gray-700">${c.transmission}</div><div class="text-xs text-gray-400">Trans</div>
          </div>
          <div class="text-center p-3 rounded-xl bg-gray-50">
            <div class="text-lg mb-1">üìç</div><div class="text-xs font-bold text-gray-700">${c.mileage>0?formatKm(c.mileage):'0 km'}</div><div class="text-xs text-gray-400">Driven</div>
          </div>
          <div class="text-center p-3 rounded-xl bg-gray-50">
            <div class="text-lg mb-1">üë§</div><div class="text-xs font-bold text-gray-700">${c.ownerType||'1st Owner'}</div><div class="text-xs text-gray-400">Owner</div>
          </div>
          <div class="text-center p-3 rounded-xl bg-gray-50">
            <div class="text-lg mb-1">üîß</div><div class="text-xs font-bold text-gray-700">${c.engine||'‚Äî'}</div><div class="text-xs text-gray-400">Engine</div>
          </div>
          <div class="text-center p-3 rounded-xl bg-gray-50">
            <div class="text-lg mb-1">üé®</div><div class="text-xs font-bold text-gray-700">${c.color||'‚Äî'}</div><div class="text-xs text-gray-400">Color</div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="bg-white rounded-2xl p-6 border border-gray-100">
        <h2 class="font-display font-bold text-gray-900 text-lg mb-3">Description</h2>
        <p class="text-gray-600 text-sm leading-relaxed">${c.description||'No description provided.'}</p>
        ${c.exchange?'<div class="mt-3 inline-flex items-center gap-2 text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full">üîÑ Exchange Accepted</div>':''}
      </div>

      <!-- Full Specs -->
      <div class="bg-white rounded-2xl p-6 border border-gray-100">
        <h2 class="font-display font-bold text-gray-900 text-lg mb-4">Full Specifications</h2>
        <div>
          ${[
            ['Make', c.make], ['Model', c.model], ['Year', c.year], ['Variant', c.variant||'‚Äî'],
            ['Condition', (c.condition||'Used').toUpperCase()], ['Body Type', c.bodyType||'‚Äî'],
            ['Fuel Type', c.fuel], ['Transmission', c.transmission], ['Engine', c.engine||'‚Äî'],
            ['Color', c.color||'‚Äî'], ['Mileage', c.mileage>0?formatKm(c.mileage):'0 km (New)'],
            ['Owner Type', c.ownerType||'‚Äî'], ['Registration State', c.state||'‚Äî'],
          ].map(([k,v]) => `<div class="spec-row"><span class="text-sm text-gray-500">${k}</span><span class="text-sm font-semibold text-gray-800">${v}</span></div>`).join('')}
        </div>
      </div>

      <!-- EMI Calculator Widget -->
      <div class="bg-white rounded-2xl p-6 border border-gray-100">
        <h2 class="font-display font-bold text-gray-900 text-lg mb-4">üí∞ EMI Calculator</h2>
        <div class="grid grid-cols-3 gap-3 mb-4">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Loan Amount (‚Çπ)</label>
            <input type="number" id="emi-loan" value="${Math.round(c.price*0.8)}" oninput="calcEMI()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-teal-500" />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Interest Rate (%)</label>
            <input type="number" id="emi-rate" value="8.5" step="0.1" oninput="calcEMI()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-teal-500" />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Tenure (months)</label>
            <input type="number" id="emi-tenure" value="60" oninput="calcEMI()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-teal-500" />
          </div>
        </div>
        <div class="p-4 rounded-xl flex items-center justify-between" style="background:linear-gradient(135deg,rgba(13,148,136,0.08),rgba(2,132,199,0.08));border:1px solid rgba(13,148,136,0.15);">
          <span class="text-gray-600 font-medium text-sm">Monthly EMI</span>
          <span class="font-display text-2xl font-bold" style="color:#0d9488" id="emi-result">‚Çπ0</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: Contact Card -->
    <div class="lg:col-span-1">
      <div class="contact-card">
        <!-- Dealer Info -->
        <div class="flex items-center gap-3 mb-5 pb-5 border-b border-gray-100">
          <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold" style="background:linear-gradient(135deg,#0d9488,#0284c7);">${(c.dealerName||'D')[0]}</div>
          <div>
            <div class="font-bold text-gray-900 text-sm">${c.dealerName||'Private Seller'}</div>
            ${c.dealerVerified?'<div class="flex items-center gap-1 text-xs text-blue-600 mt-0.5"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Verified Dealer</div>':''}
          </div>
        </div>

        <!-- Price -->
        <div class="text-center mb-5">
          <div class="font-display text-3xl font-bold" style="color:#0f766e">${formatPrice(c.price)}</div>
          ${c.negotiable?'<div class="text-xs text-green-600 mt-1">‚úÖ Price negotiable</div>':''}
        </div>

        <!-- Contact Buttons -->
        <div class="space-y-3 mb-5">
          <button onclick="revealPhone()" class="call-btn" id="phone-btn">
            üìû Show Phone Number
          </button>
          ${c.whatsApp?`<a href="https://wa.me/${c.whatsApp.replace(/\D/g,'')}?text=Hi! I'm interested in your ${c.year} ${c.make} ${c.model} listed on MileVaahan." target="_blank" class="whatsapp-btn">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm.029 18.88a9.868 9.868 0 01-4.927-1.319l-.355-.211-3.672.963.98-3.587-.232-.368A9.86 9.86 0 012.14 12.03C2.14 6.53 6.523 2.14 12.03 2.14c2.625 0 5.092 1.023 6.946 2.878A9.813 9.813 0 0121.921 12c-.004 5.5-4.387 9.88-9.892 9.88z"/></svg>
            WhatsApp
          </a>`:''}
        </div>

        <!-- Inquiry Form -->
        <div class="border-t border-gray-100 pt-4">
          <h3 class="font-display font-bold text-gray-800 text-sm mb-3">Send Inquiry</h3>
          <div class="space-y-3">
            <input type="text" id="inq-name" placeholder="Your name *" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-teal-500" />
            <input type="tel" id="inq-phone" placeholder="Your phone *" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-teal-500" />
            <textarea id="inq-msg" rows="3" placeholder="Message (optional)" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm resize-none focus:outline-none focus:border-teal-500">Hi! I'm interested in this ${c.make} ${c.model}. Please contact me.</textarea>
            <button onclick="sendInquiry()" class="w-full py-3 rounded-xl text-white font-bold text-sm" style="background:linear-gradient(135deg,#0d9488,#0284c7);">Send Inquiry</button>
          </div>
        </div>

        <!-- Share -->
        <div class="flex gap-2 mt-4 pt-4 border-t border-gray-100">
          <button onclick="shareWhatsApp()" class="flex-1 py-2 rounded-lg text-xs font-semibold text-center" style="background:#25D36618;color:#25D366;">Share on WhatsApp</button>
          <button onclick="copyLink()" class="flex-1 py-2 rounded-lg text-xs font-semibold text-center" style="background:#f1f5f9;color:#64748b;">üìã Copy Link</button>
        </div>
      </div>
    </div>`;

  document.getElementById('car-content').innerHTML = html;
  calcEMI();
}

function updateSEO() {
  if (!carData) return;
  const c = carData;
  const title = c.seo?.title || `${c.year} ${c.make} ${c.model} for Sale in ${c.city} | MileVaahan`;
  const desc = c.seo?.description || `Buy ${c.year} ${c.make} ${c.model} in ${c.city}. ${c.fuel}, ${c.transmission}. ${c.mileage>0?formatKm(c.mileage)+' driven.':''} Price: ${formatPrice(c.price)}.`;
  document.getElementById('page-title').textContent = title;
  document.getElementById('page-desc').content = desc;
  document.getElementById('og-title').content = title;
  document.getElementById('og-desc').content = desc;
  if (c.images?.[0]) document.getElementById('og-image').content = c.images[0];
  document.getElementById('page-canonical').href = `https://www.milevaahan.com/pages/car-detail.html?id=${c.id}`;

  // JSON-LD
  const schema = {
    "@context":"https://schema.org",
    "@type":"Car",
    "name":`${c.year} ${c.make} ${c.model}`,
    "brand":{"@type":"Brand","name":c.make},
    "model":c.model,
    "vehicleModelDate":c.year,
    "fuelType":c.fuel,
    "vehicleTransmission":c.transmission,
    "mileageFromOdometer":{"@type":"QuantitativeValue","value":c.mileage,"unitCode":"KMT"},
    "color":c.color,
    "bodyType":c.bodyType,
    "offers":{"@type":"Offer","price":c.price,"priceCurrency":"INR","availability":"https://schema.org/InStock"},
    "description":c.description,
    "image":c.images||[],
    "seller":{"@type":"AutoDealer","name":c.dealerName,"address":{"@type":"PostalAddress","addressLocality":c.city,"addressRegion":c.state,"addressCountry":"IN"}}
  };
  document.getElementById('car-schema').textContent = JSON.stringify(schema);
}

function setImg(idx) {
  currentImgIdx = idx;
  const imgs = carData?.images||[];
  const mainImg = document.getElementById('main-img');
  if (mainImg && imgs[idx]) mainImg.src = imgs[idx];
  document.querySelectorAll('.thumb').forEach((t,i) => t.classList.toggle('active', i===idx));
}
function prevImg() { const len=carData?.images?.length||1; setImg((currentImgIdx-1+len)%len); }
function nextImg() { const len=carData?.images?.length||1; setImg((currentImgIdx+1)%len); }

function calcEMI() {
  const P = parseFloat(document.getElementById('emi-loan')?.value||0);
  const r = parseFloat(document.getElementById('emi-rate')?.value||8.5)/100/12;
  const n = parseInt(document.getElementById('emi-tenure')?.value||60);
  if (P && r && n) {
    const emi = P * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1);
    const el = document.getElementById('emi-result');
    if (el) el.textContent = formatPrice(Math.round(emi));
  }
}

function revealPhone() {
  const btn = document.getElementById('phone-btn');
  if (btn.textContent.includes('Show')) {
    btn.textContent = `üìû ${carData?.phone||'+91 98765 43210'}`;
    btn.style.background = 'linear-gradient(135deg,#059669,#047857)';
  } else {
    window.location.href = `tel:${carData?.phone}`;
  }
}

async function sendInquiry() {
  const name = document.getElementById('inq-name').value.trim();
  const phone = document.getElementById('inq-phone').value.trim();
  if (!name || !phone) { showToast('Please enter your name and phone', 'error'); return; }
  try {
    await db.collection(COLLECTIONS.INQUIRIES).add({
      listingId: carData.id,
      dealerId: carData.dealerId,
      buyerName: name,
      buyerPhone: phone,
      message: document.getElementById('inq-msg').value,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showToast('‚úÖ Inquiry sent! The dealer will contact you soon.');
  } catch(e) { showToast('‚úÖ Inquiry sent! (demo mode)'); }
}

function shareWhatsApp() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent(`Check out this ${carData?.year} ${carData?.make} ${carData?.model} for ${formatPrice(carData?.price)} on MileVaahan`);
  window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
}

function copyLink() {
  navigator.clipboard.writeText(window.location.href).then(() => showToast('‚úÖ Link copied!'));
}

function showError() {
  document.getElementById('car-content').innerHTML = '<div class="col-span-3 text-center py-20"><div class="text-5xl mb-4">üöó</div><h2 class="text-xl font-bold text-gray-700">Car not found</h2><a href="listings.html" class="mt-4 inline-block text-teal-600 hover:underline">Browse all listings ‚Üí</a></div>';
}
</script>
</body>
</html>